CREATE DATABASE QUANLYPHONGTRO_LTUD
USE  QUANLYPHONGTRO_LTUD

create table PHONGTRO
 (
	IDPHONG INT ,
	TANG [NVARCHAR](10) NOT NULL,
	KIEUPHONG NVARCHAR(30)  NOT NULL,
	SUCCHUA INT  NOT NULL,
	TENTIENICH NVARCHAR(100)  NOT NULL,
	GIATIEN INT  NOT NULL,
	TRANGTHAI [NVARCHAR](10) default 'available' NOT NULL,
	PRIMARY KEY (IDPHONG),
);
INSERT INTO PHONGTRO(IDPHONG,TANG,KIEUPHONG,SUCCHUA,TENTIENICH,GIATIEN) VALUES (101,1,N'Đơn',1,N'Nội Thất/Wifi',500000)
INSERT INTO PHONGTRO(IDPHONG,TANG,KIEUPHONG,SUCCHUA,TENTIENICH,GIATIEN) VALUES (102,1,N'Đôi',2,N'Nội Thất/Wifi/Nóng lạnh/Điều hòa',2000000)
INSERT INTO PHONGTRO(IDPHONG,TANG,KIEUPHONG,SUCCHUA,TENTIENICH,GIATIEN) VALUES (103,1,N'Đôi',2,N'Nội Thất/Wifi/Nóng lạnh/Điều hòa/Máy giặt',1500000)
INSERT INTO PHONGTRO(IDPHONG,TANG,KIEUPHONG,SUCCHUA,TENTIENICH,GIATIEN) VALUES (201,2,N'Đơn',1,N'Nội Thất/Wifi',500000)
INSERT INTO PHONGTRO(IDPHONG,TANG,KIEUPHONG,SUCCHUA,TENTIENICH,GIATIEN) VALUES (202,2,N'Đa',4,N'Nội Thất/Wifi/Nóng lạnh/Điều hòa/Máy giặt',4500000)
INSERT INTO PHONGTRO(IDPHONG,TANG,KIEUPHONG,SUCCHUA,TENTIENICH,GIATIEN) VALUES (203,2,N'Đa',4,N'Nội Thất/Wifi/Nóng lạnh/Điều hòa/Máy giặt',4500000)
INSERT INTO PHONGTRO(IDPHONG,TANG,KIEUPHONG,SUCCHUA,TENTIENICH,GIATIEN) VALUES (301,3,N'Đôi',2,N'Nội Thất/Wifi/Nóng lạnh/Điều hòa/Máy giặt',2500000)
INSERT INTO PHONGTRO(IDPHONG,TANG,KIEUPHONG,SUCCHUA,TENTIENICH,GIATIEN) VALUES (302,3,N'Đơn',1,N'Nội Thất/Wifi/Nóng lạnh/Điều hòa',750000)
INSERT INTO PHONGTRO(IDPHONG,TANG,KIEUPHONG,SUCCHUA,TENTIENICH,GIATIEN) VALUES (303,3,N'Đôi',2,N'Nội Thất/Wifi/Nóng lạnh/Điều hòa/Máy giặt',1500000)
INSERT INTO PHONGTRO(IDPHONG,TANG,KIEUPHONG,SUCCHUA,TENTIENICH,GIATIEN) VALUES (304,3,N'Đa',3,N'Nội Thất/Wifi/Nóng lạnh/Điều hòa/Máy giặt',3500000)
INSERT INTO PHONGTRO(IDPHONG,TANG,KIEUPHONG,SUCCHUA,TENTIENICH,GIATIEN) VALUES (401,1,N'Đơn',1,N'Nội Thất/Wifi',500000)


create table KHACHHANG (
	IDKHACHHANG INT Identity(1,1),
	IDPHONG INT,
	TEN NVARCHAR(50),
	CANCUOC NVARCHAR(20),	
	DIENTHOAI NVARCHAR(12) UNIQUE, CHECK (DIENTHOAI NOT LIKE '%[^0-9]%'),
	QUEQUAN NVARCHAR(50),
	NOILAMVIEC NVARCHAR(50),
	TIENCOC INT,
	NGAYTHUE NVARCHAR(30),
	NGAYTRA NVARCHAR(30),
	FOREIGN KEY(IDPHONG) REFERENCES PHONGTRO(IDPHONG),
	PRIMARY KEY ([IDKHACHHANG]) 
); 

insert into KHACHHANG ( IDPHONG, TEN, CANCUOC, DIENTHOAI, QUEQUAN, NOILAMVIEC, TIENCOC, NGAYTHUE ) values ( 101, N'Nguyen Huy Hoang', '3453253245', '0565453443', N'Tây Sơn', N'Hà Nội', 200000, '17-07-2021');
insert into KHACHHANG ( IDPHONG, TEN, CANCUOC, DIENTHOAI, QUEQUAN, NOILAMVIEC, TIENCOC, NGAYTHUE ) values ( 102, N'Nguyễn Hải Lý', '1453253225', '0388180294', N'Nghệ An', N'Hà Nội', 200000, '15-07-2021');
insert into KHACHHANG ( IDPHONG, TEN, CANCUOC, DIENTHOAI, QUEQUAN, NOILAMVIEC, TIENCOC, NGAYTHUE ) values ( 102, N'Trần Hải Trọng', '3928402346', '0998321722', N'Hà Tĩnh', N'Hà Nội', 200000, '15-09-2021');
insert into KHACHHANG ( IDPHONG, TEN, CANCUOC, DIENTHOAI, QUEQUAN, NOILAMVIEC, TIENCOC, NGAYTHUE ) values ( 103, N'Minh Hải', '9089485947', '0938432748', N'Hải Dương', 'Hà Nội', 200000, '15-04-2021');
insert into KHACHHANG ( IDPHONG, TEN, CANCUOC, DIENTHOAI, QUEQUAN, NOILAMVIEC, TIENCOC, NGAYTHUE ) values ( 103, N'Mai Nhi', '5098329494', '0394782343', N'Hưng Yên', N'Hà Nội', 200000, '24-04-2021');
insert into KHACHHANG ( IDPHONG, TEN, CANCUOC, DIENTHOAI, QUEQUAN, NOILAMVIEC, TIENCOC, NGAYTHUE ) values ( 201, N'Phan Thị Hoài Thương', '0945238322', '0942873732', N'Hà Tĩnh', N'Hà Nội', 200000, '15-06-2020');
insert into KHACHHANG ( IDPHONG, TEN, CANCUOC, DIENTHOAI, QUEQUAN, NOILAMVIEC, TIENCOC, NGAYTHUE ) values ( 202, N'Thái T. Thảo Quyên', '0481982499', '0565453343', N'Nghệ An', N'Hà Nội', 200000, '15-04-2021');
insert into KHACHHANG ( IDPHONG, TEN, CANCUOC, DIENTHOAI, QUEQUAN, NOILAMVIEC, TIENCOC, NGAYTHUE ) values ( 202, N'Nhàn Phùng', '4390589293', '0324732642', N'Thanh Hóa', N'Hà Nội', 200000, '12-07-2021');
insert into KHACHHANG ( IDPHONG, TEN, CANCUOC, DIENTHOAI, QUEQUAN, NOILAMVIEC, TIENCOC, NGAYTHUE ) values ( 202, N'Nguyen Thao Anh', '5979202543', '0237112344', N'Hải Dương', N'Hà Nội', 200000, '23-07-2021');
insert into KHACHHANG ( IDPHONG, TEN, CANCUOC, DIENTHOAI, QUEQUAN, NOILAMVIEC, TIENCOC, NGAYTHUE ) values ( 203, N'Ngo Tuyet Giau', '5089045398', '0973284238', N'Hưng Yên', N'Hà Nội', 200000, '15-08-2021');
insert into KHACHHANG ( IDPHONG, TEN, CANCUOC, DIENTHOAI, QUEQUAN, NOILAMVIEC, TIENCOC, NGAYTHUE ) values ( 203, N'Kiều Anh', '3003023322', '0839274324', N'Bắc Giang', N'Hà Nội', 200000, '15-12-2021');
insert into KHACHHANG ( IDPHONG, TEN, CANCUOC, DIENTHOAI, QUEQUAN, NOILAMVIEC, TIENCOC, NGAYTHUE ) values ( 203, N'Huyền Trang', '9457789435', '0438792738', N'Hải Dương', N'Hà Nội', 200000, '11-11-2021');
insert into KHACHHANG ( IDPHONG, TEN, CANCUOC, DIENTHOAI, QUEQUAN, NOILAMVIEC, TIENCOC, NGAYTHUE ) values ( 301, N'Kiều Trang', '2187459884', '0893478234', N'Ninh Bình', N'Hà Nội', 200000, '15-07-2022');
insert into KHACHHANG ( IDPHONG, TEN, CANCUOC, DIENTHOAI, QUEQUAN, NOILAMVIEC, TIENCOC, NGAYTHUE ) values ( 302, N'Hà Lê', '9868781837', '0998787336', N'Vĩnh Phúc', N'Hà Nội', 200000, '15-01-2022');
insert into KHACHHANG ( IDPHONG, TEN, CANCUOC, DIENTHOAI, QUEQUAN, NOILAMVIEC, TIENCOC, NGAYTHUE ) values ( 303, N'Nguyễn Thị Giang', '4958353467', '0989098034', N'Nam Định', N'Hà Nội', 200000, '12-01-2021');
insert into KHACHHANG ( IDPHONG, TEN, CANCUOC, DIENTHOAI, QUEQUAN, NOILAMVIEC, TIENCOC, NGAYTHUE ) values ( 304, N'Vũ Hải Hoàng', '1298732000', '0948732498', N'Nam Định', N'Hà Nội', 200000, '15-07-2020');
insert into KHACHHANG ( IDPHONG, TEN, CANCUOC, DIENTHOAI, QUEQUAN, NOILAMVIEC, TIENCOC, NGAYTHUE ) values ( 304, N'Lê Bình Minh', '4309801133', '0994823423', N'Nam Định', N'Hà Nội', 200000, '25-07-2021');
insert into KHACHHANG ( IDPHONG, TEN, CANCUOC, DIENTHOAI, QUEQUAN, NOILAMVIEC, TIENCOC, NGAYTHUE ) values ( 401, N'Thanh Bình', '4398324093', '0999943933', N'Thái Bình', N'Hà Nội', 200000, '05-08-2020');
select * from KHACHHANG


create table DICHVU (
	IDDICHVUPHONG INT Identity(1,1),
	IDPHONG INT,
	TIENDIEN INT,
	TIENNUOC INT,
	TIENDICHVU INT,
	IsLaundrying NVARCHAR(20),
	IsParking  NVARCHAR(20),
	FOREIGN KEY(IDPHONG) REFERENCES PHONGTRO(IDPHONG),
	PRIMARY KEY (IDDICHVUPHONG) 
);
insert into DICHVU (IDPHONG, TIENDIEN, TIENNUOC, TIENDICHVU, IsLaundrying, IsParking) values (101, 33000, 50000, 115000, N'Có', N'Không');
insert into DICHVU (IDPHONG, TIENDIEN, TIENNUOC, TIENDICHVU, IsLaundrying, IsParking) values (102, 259000, 491000, 127000, N'Có', N'Có');
insert into DICHVU (IDPHONG, TIENDIEN, TIENNUOC, TIENDICHVU, IsLaundrying, IsParking) values (103, 453000, 382000, 195000, N'Có', N'Có');
insert into DICHVU (IDPHONG, TIENDIEN, TIENNUOC, TIENDICHVU, IsLaundrying, IsParking) values (201, 120000, 100000, 170000, N'Có', N'Có');
insert into DICHVU (IDPHONG, TIENDIEN, TIENNUOC, TIENDICHVU, IsLaundrying, IsParking) values (202, 389000, 387000, 155000, N'Có', N'Có');
insert into DICHVU (IDPHONG, TIENDIEN, TIENNUOC, TIENDICHVU, IsLaundrying, IsParking) values (203, 290000, 268000, 124000, N'Không', N'Không');
insert into DICHVU (IDPHONG, TIENDIEN, TIENNUOC, TIENDICHVU, IsLaundrying, IsParking) values (301, 290000, 268000, 124000, N'Không', N'Không');
insert into DICHVU (IDPHONG, TIENDIEN, TIENNUOC, TIENDICHVU, IsLaundrying, IsParking) values (302, 290000, 268000, 124000, N'Không', N'Không');
insert into DICHVU (IDPHONG, TIENDIEN, TIENNUOC, TIENDICHVU, IsLaundrying, IsParking) values (303, 290000, 268000, 124000, N'Không', N'Không');
insert into DICHVU (IDPHONG, TIENDIEN, TIENNUOC, TIENDICHVU, IsLaundrying, IsParking) values (401, 29000, 50000, 124000, N'Không', N'Không');
select * from DICHVU


create table THANHTOAN (
	IDMATHANHTOAN INT Identity(1,1),
	IDPHONG INT, 
	IDKHACHHANG INT,
	IDDICHVUPHONG INT,
	TONGTIENPHONG INT, 
	FOREIGN KEY(IDPHONG) REFERENCES PHONGTRO(IDPHONG),
	FOREIGN KEY(IDKHACHHANG) REFERENCES KHACHHANG(IDKHACHHANG),
	FOREIGN KEY(IDDICHVUPHONG) REFERENCES DICHVU(IDDICHVUPHONG),
	PRIMARY KEY ([IDMATHANHTOAN]) 
);
insert into THANHTOAN (IDPHONG, IDKHACHHANG, IDDICHVUPHONG) values (101, 1, 1);
insert into THANHTOAN (IDPHONG, IDKHACHHANG, IDDICHVUPHONG) values (102, 2, 2);

select * from THANHTOAN


create table HOADON (
	IDMAHOADON INT Identity(1,1),
	IDPHONG INT,
	IDKHACHHANG INT,
	TENKHACHHANG NVARCHAR(50),
	NGAYTHANHTOAN date,
	THANHTOAN INT, 
	FOREIGN KEY(IDPHONG) REFERENCES PHONGTRO(IDPHONG),
	FOREIGN KEY(IDKHACHHANG) REFERENCES KHACHHANG(IDKHACHHANG),
	PRIMARY KEY (IDMAHOADON) 
)
select * from HOADON

Create view QuanLyKhachHang as
(
Select KHACHHANG.IDKHACHHANG,KHACHHANG.TEN,KHACHHANG.CANCUOC,KHACHHANG.DIENTHOAI,KHACHHANG.QUEQUAN,KHACHHANG.NOILAMVIEC,KHACHHANG.TIENCOC,KHACHHANG.NGAYTHUE,PHONGTRO.TANG,PHONGTRO.KIEUPHONG,PHONGTRO.IDPHONG,PHONGTRO.GIATIEN
FROM KHACHHANG,PHONGTRO
WHERE KHACHHANG.IDPHONG=PHONGTRO.IDPHONG
)


create view Tiendichvu as
(
select PHONGTRO.TANG,PHONGTRO.IDPHONG,KHACHHANG.TEN,KHACHHANG.DIENTHOAI,DICHVU.IsParking,DICHVU.IsLaundrying,DICHVU.TIENDIEN,DICHVU.TIENNUOC,DICHVU.TIENDICHVU
FROM KHACHHANG,PHONGTRO,DICHVU
WHERE KHACHHANG.IDPHONG=PHONGTRO.IDPHONG AND DICHVU.IDPHONG =PHONGTRO.IDPHONG
)

create view ThanhToanTien as
(
select KHACHHANG.IDKHACHHANG, KHACHHANG.TEN,PHONGTRO.IDPHONG,PHONGTRO.TANG,DICHVU.IsParking,DICHVU.IsLaundrying,DICHVU.TIENDIEN,DICHVU.TIENNUOC,DICHVU.TIENDICHVU,GIATIEN,KHACHHANG.DIENTHOAI,TONGTIENPHONG
FROM KHACHHANG,PHONGTRO,DICHVU,THANHTOAN
WHERE KHACHHANG.IDKHACHHANG=THANHTOAN.IDKHACHHANG and THANHTOAN.IDPHONG = PHONGTRO.IDPHONG AND PHONGTRO.IDPHONG = DICHVU.IDPHONG
)

update ThanhToanTien
set TONGTIENPHONG = GIATIEN+TIENDICHVU+TIENDIEN+TIENNUOC

SELECT * FROM ThanhToanTien

